name: Build MomSurfFix Extension on Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install build dependencies (GCC 9 + 32bit)
      # é‡‡ç”¨æœ€ç¨³å¦¥çš„æ‹†åˆ†å®‰è£…æ³•ï¼Œä¿è¯ç¯å¢ƒæ— è¯¯
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        
        # 1. å®‰è£…ç¼–è¯‘å™¨æœ¬ä½“
        sudo apt-get install -y --no-install-recommends \
          gcc-9 g++-9
          
        # 2. æ‰‹åŠ¨å®‰è£… 32 ä½è¿è¡Œåº“ (å…³é”®)
        sudo apt-get install -y --no-install-recommends \
          libc6-dev-i386 \
          lib32stdc++6 \
          lib32z1-dev
          
        # 3. åŸºç¡€å·¥å…·
        sudo apt-get install -y --no-install-recommends \
          make python3 python3-pip git ca-certificates

    - name: Install AMBuild
      run: |
        git clone https://github.com/alliedmodders/ambuild
        cd ambuild
        python3 setup.py install --user
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Checkout SourceMod SDKs
      run: |
        mkdir -p sdks
        cd sdks
        git clone --recursive https://github.com/alliedmodders/sourcemod -b 1.12-dev sourcemod
        git clone --recursive https://github.com/alliedmodders/metamod-source -b 1.12-dev mmsource
        git clone --recursive https://github.com/alliedmodders/hl2sdk -b csgo hl2sdk-csgo

    - name: Configure
      # å¼ºåˆ¶ç¯å¢ƒå˜é‡ï¼Œé…åˆ configure -o ä½¿ç”¨
      env:
        CC: gcc-9
        CXX: g++-9
      run: |
        # 1. æ¸…ç†ç¯å¢ƒï¼Œé˜²æ­¢æ®‹ç•™
        rm -rf build
        
        # 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘æ˜¾å¼æŒ‡å®š -o build è¾“å‡ºç›®å½•
        # å½»åº•è§£å†³ .ambuild2/vars è·¯å¾„é”™ä¹±çš„é—®é¢˜
        python3 configure.py -o build \
          --sdks=csgo \
          --targets=x86 \
          --sm-path="${{ github.workspace }}/sdks/sourcemod" \
          --mms-path="${{ github.workspace }}/sdks/mmsource" \
          --hl2sdk-path="${{ github.workspace }}/sdks/hl2sdk-csgo"
          
        # 3. ğŸ”¥ å¼ºåˆ¶æ ¡éªŒï¼šå¦‚æœ vars æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥åœ¨æ­¤å¤„æŠ¥é”™ï¼Œä¸ç•™åˆ°ä¸‹ä¸€æ­¥
        test -f build/.ambuild2/vars

    - name: Build
      env:
        CC: gcc-9
        CXX: g++-9
      run: |
        # ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¸å† cd buildï¼Œç›´æ¥åœ¨æ ¹ç›®å½•è°ƒç”¨ ambuild æŒ‡å®šæ„å»ºç›®å½•
        ambuild build

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: momsurffix_ext_linux
        path: build/package/addons/sourcemod/extensions/momsurffix_ext.ext.so
