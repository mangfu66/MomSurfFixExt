# AMBuildScript - 定义构建逻辑

import os

# 检测 C++ 编译器，使用注入的目标架构
cxx = builder.DetectCxx(target_arch=builder.options.targets)

# 创建动态库目标
library = cxx.Library('momsurffix_ext.ext')

# 添加源文件
library.sources += [
    'momsurffix_ext.cpp',
]

# 添加包括路径，使用注入的选项，并添加当前源目录
library.compiler.includes += [
    builder.sourcePath,  # 添加仓库根目录，以包含 smsdk_config.h
    os.path.join(builder.options.sm_path, 'public'),
    os.path.join(builder.options.sm_path, 'public/extensions'),
    os.path.join(builder.options.sm_path, 'public/sourcepawn'),
    os.path.join(builder.options.sm_path, 'sourcepawn/include'),
    os.path.join(builder.options.mms_path, 'core'),
    os.path.join(builder.options.mms_path, 'core/sourcehook'),
    os.path.join(builder.options.hl2sdk_path, 'public'),
    os.path.join(builder.options.hl2sdk_path, 'public/engine'),
    os.path.join(builder.options.hl2sdk_path, 'public/mathlib'),
    os.path.join(builder.options.hl2sdk_path, 'public/vstdlib'),
    os.path.join(builder.options.hl2sdk_path, 'public/tier0'),
    os.path.join(builder.options.hl2sdk_path, 'public/tier1'),
]

# 添加链接标志和库（针对 Linux 32位）
library.compiler.linkflags += ['-m32']
library.compiler.postlink += [
    os.path.join(builder.options.hl2sdk_path, 'lib/linux/tier1_i486.a'),
    os.path.join(builder.options.hl2sdk_path, 'lib/linux/mathlib_i486.a'),
]

# 添加预处理器定义
library.compiler.defines += ['SOURCEMOD_BUILD', 'HAVE_STRING_H']

# 添加到构建图
builder.Add(library)
