# AMBuildScript
import os

# 1. æ£€æµ‹ç¼–è¯‘å™¨
cxx = builder.DetectCxx(target_arch=builder.options.targets)
library = cxx.Library('momsurffix_ext.ext')

# 2. æºæ–‡ä»¶ (ä¿ç•™ smsdk_ext.cpp æ˜¯æ­£ç¡®çš„ï¼Œä¸è¦åˆ )
sm_path = builder.options.sm_path
library.sources += [
    'momsurffix_ext.cpp',
    'simple_detour.cpp',
    os.path.join(sm_path, 'public', 'smsdk_ext.cpp')
]

# 3. è·å–å…¶ä»–è·¯å¾„å‚æ•° (âŒ åˆ é™¤ mms_path)
hl2sdk_path = builder.options.hl2sdk_path

# 4. å¤´æ–‡ä»¶åŒ…å«è·¯å¾„ (âŒ å½»åº•ç§»é™¤ Metamod ç›¸å…³è·¯å¾„)
library.compiler.includes += [
    builder.sourcePath,
    os.path.join(sm_path, 'public'),
    os.path.join(sm_path, 'public/extensions'),
    os.path.join(sm_path, 'public/sourcepawn'),
    os.path.join(sm_path, 'sourcepawn/include'),
    os.path.join(sm_path, 'public/amtl'),
    os.path.join(sm_path, 'public/amtl/amtl'),
    os.path.join(sm_path, 'third_party/amtl'),
    os.path.join(sm_path, 'third_party/amtl/amtl'),
    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¸‹é¢è¿™é‡ŒåŸæ¥çš„ mms_path å¿…é¡»å…¨éƒ¨åˆ æ‰ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    os.path.join(hl2sdk_path, 'public'),
    os.path.join(hl2sdk_path, 'public/engine'),
    os.path.join(hl2sdk_path, 'public/mathlib'),
    os.path.join(hl2sdk_path, 'public/vstdlib'),
    os.path.join(hl2sdk_path, 'public/tier0'),
    os.path.join(hl2sdk_path, 'public/tier1'),
    os.path.join(hl2sdk_path, 'game/shared'),
    os.path.join(hl2sdk_path, 'common'),
]

# 5. æ ¸å¿ƒå®å®šä¹‰
library.compiler.defines += [
    'SOURCEMOD_BUILD',
    'HAVE_STRING_H',
    'SE_EPISODEONE',
    'COMPILER_GCC',
    '_LINUX',
    'LINUX',
    'POSIX',
    '_POSIX',
    '_NATIVE_WCHAR_T_DEFINED',
    'register=', 
    'GNUC', 
]

# 6. ç¼–è¯‘å™¨æ ‡å¿—
library.compiler.cxxflags += [
    '-std=c++17',
    '-fno-threadsafe-statics',
    '-fvisibility=hidden',
    '-fshort-wchar',
    '-fms-extensions',
    '-msse',
    '-msse2',
    '-Wno-deprecated-declarations',
    '-Wno-macro-redefined',
    '-Wno-register',
    '-Wno-invalid-offsetof',
]

# =============================================================================
# é“¾æ¥è®¾ç½®
# =============================================================================

# 1. è®¾ç½® SDK åº“ç›®å½•
libdir = os.path.join(hl2sdk_path, 'lib', 'linux')

# 2. é“¾æ¥å™¨æ ‡å¿—
library.compiler.linkflags += ['-lm', '-ldl', '-L' + libdir]

# 3. æ™ºèƒ½åˆ¤æ–­åº“åç§°
name_tier0 = 'tier0'
if os.path.exists(os.path.join(libdir, 'libtier0_srv.so')):
    name_tier0 = 'tier0_srv'

name_vstdlib = 'vstdlib'
if os.path.exists(os.path.join(libdir, 'libvstdlib_srv.so')):
    name_vstdlib = 'vstdlib_srv'

# 4. Postlink
library.compiler.postlink += [
    os.path.join(libdir, 'tier1_i486.a'),
    os.path.join(libdir, 'mathlib_i486.a'),
    os.path.join(libdir, 'interfaces_i486.a'),
    '-l' + name_tier0,
    '-l' + name_vstdlib,
]

builder.Add(library)
